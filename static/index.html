<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورود به سامانه تعاونی</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.20/dist/full.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fontsource/vazirmatn@latest/index.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Vazirmatn, sans-serif; background: linear-gradient(to right, #a8e6cf, #dcedc1); }
        /* استایل برای نمایش بهتر متن دیباگ */
        #modal_message { white-space: pre-wrap; text-align: left; direction: ltr; }
    </style>
</head>
<body>
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
        <h1 class="text-2xl font-bold text-center mb-6">ورود به سامانه تعاونی</h1>
        <div id="step-1">
            <label class="block mb-2 font-semibold">کد ملی خود را وارد کنید:</label>
            <input type="text" id="nationalIdInput" class="input input-bordered w-full mb-4" placeholder="مثال: 0012345678" maxlength="10">
            <label class="block mb-2 font-semibold">شماره موبایل خود را وارد کنید:</label>
            <input type="tel" id="phoneInput" class="input input-bordered w-full mb-4" placeholder="مثال: 09123456789" maxlength="11">
            <button id="sendCodeBtn" onclick="generateLink()" class="btn btn-success w-full">ادامه</button>
            <p id="msg" class="text-sm text-red-500 mt-2 text-center"></p>
        </div>
        </div>

    <dialog id="message_modal" class="modal">
        <div class="modal-box max-w-2xl text-center">
            <h3 id="modal_title" class="font-bold text-lg"></h3>
            <pre id="modal_message" class="py-4 bg-gray-100 p-4 rounded-md overflow-x-auto"></pre>
            <div class="modal-action justify-center">
                <form method="dialog"><button id="modal_button" class="btn">بستن</button></form>
            </div>
        </div>
    </dialog>

    <script>
        const API_BACKEND_URL = "https://tavonibot.onrender.com";

        function showModal(title, message, isSuccess) {
            const modal = document.getElementById('message_modal');
            document.getElementById('modal_title').textContent = title;
            document.getElementById('modal_message').textContent = message;
            const modalButton = document.getElementById('modal_button');
            modalButton.className = 'btn';
            if (isSuccess) { modalButton.classList.add('btn-success'); } 
            else { modalButton.classList.add('btn-error'); }
            modal.showModal();
        }

        async function generateLink() {
            const nationalId = document.getElementById('nationalIdInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            const msgEl = document.getElementById('msg');
            const sendBtn = document.getElementById('sendCodeBtn');
            msgEl.textContent = '';
            
            sendBtn.disabled = true;
            sendBtn.textContent = 'لطفاً صبر کنید...';

            try {
                const response = await fetch(`${API_BACKEND_URL}/generate-linking-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        national_id: nationalId,
                        phone_number: phone
                    })
                });

                const result = await response.json();

                // --- بخش اصلاح شده برای نمایش اطلاعات دیباگ ---
                if (response.ok && result.message === "DEBUGGING_INFORMATION") {
                    const debugText = JSON.stringify(result, null, 2); // فرمت‌بندی جیسون برای خوانایی
                    showModal('Debugging Information', debugText, false);
                } else {
                    // مدیریت خطاهای عادی
                    msgEl.textContent = result.error || 'یک خطای ناشناخته رخ داد.';
                }
                // --- پایان بخش اصلاح شده ---

            } catch (error) {
                console.error('Fetch Error:', error);
                showModal('خطا', 'خطا در برقراری ارتباط با سرور.', false);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'ادامه';
            }
        }
    </script>
</body>
</html>
